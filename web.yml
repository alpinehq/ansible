---
- hosts: webservers
  vars:
    traefik_network: traefik-public
  remote_user: root

  tasks:
    # - include_role:
    #     name: common
    #   tags:
    #     - setup
    - include_role:
        name: docker
      tags:
        - setup

    # traefik setup/install
    - name: Create shared network
      docker_network:
        name: "{{ traefik_network }}"
        state: present
        scope: local
        driver: "bridge"
      tags:
        - setup
    - name: Create traefik dir
      file:
        path: /etc/traefik
        state: directory
        recurse: yes
      tags:
        - setup
    - name: Template /etc/traefik/docker-compose.yml
      vars:
        acme_email: "matt.rasband@gmail.com"
        digitalocean_token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          65636461393861643834376363366462653031613162313966366163393538656538393834376263
          6238643565396635613437346137663237663163643432650a343137313737653764356333623666
          32653133656235383339666264303164663065333462333738313831626465653437646666366633
          3837346538343866320a343961613361653361366366383635366361626138366162313261343865
          35393635366562313734663063313232643663373331666135353630313336653534363731346136
          65336237623337363931303238646563643833666435643830393731333439643662653563313636
          33636430666531663332373861393934313030356433333232613233343631343066346166313065
          62616164336564646634
        traefik_domain: "alpinehq.dev"
        traefik_user: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32383866373434346365343961313839633865313330306537316636656238616231633530656361
          3335623336333536393262613133633364623435316430340a346335383266376233393566356634
          37626330343639626639616132343762633538633538316336306636653133613263663432633837
          3631343262323266660a636638323531663062663861353131633934316432376334653465356434
          3734
        traefik_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66623130633864363738366337306136613861316437633433356462323232623339313436633462
          3664333365323936623634616332373764363636633539650a336636633538363933353461363935
          66323563643462363564306261393531316131633835356130343936623330663361653639616162
          6464313561373966340a653233393737366131623733306639306436313337366338353439613531
          35653965323530366534326466616462666436643537333335323236643337383039313238353037
          3839353739613136636366376636636465666134373765653235
      template:
        src: etc/traefik/docker-compose.yml
        dest: /etc/traefik/docker-compose.yml
      tags:
        - setup
        - deploy
    - name: Restart traefik
      docker_compose:
        project_src: /etc/traefik
        pull: yes
        restarted: yes
      tags:
        - setup
        - deploy
